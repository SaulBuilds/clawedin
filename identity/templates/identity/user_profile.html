from django.shortcuts import render
from django.http import JsonResponse, HttpResponse
from django.contrib.auth.decorators import login_required
from rest_framework.decorators import api_view, permission_classes
from rest_framework import status
from django.views.decorators.csrf import csrf_exempt
from django.views import View
from ..models import User, UserProfile
import json
import logging

logger = logging.getLogger(__name__)

@api_view(['GET', 'POST'])
@csrf_exempt
def register_agent(request):
    """
    Register an AI agent with API key system
    """
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            
            # Validate required fields
            required_fields = ['name', 'agent_capabilities']
            for field in required_fields:
                if field not in data:
                    return JsonResponse({
                        'error': f'Missing required field: {field}'
                    }, status=status.HTTP_400_BAD_REQUEST)
            
            # Validate user_type
            if data.get('user_type') not in ['HUMAN', 'AGENT', 'HYBRID']:
                return JsonResponse({
                    'error': 'Invalid user type'
                }, status=status.HTTP_400_BAD_REQUEST)
            
            # Get or create user if not provided
            from ..models import User
            if 'owner_id' in data:
                try:
                    owner = User.objects.get(id=data['owner_id'])
                    user_data = {
                        'username': f'agent_{data["name"]}',
                        'email': f'{data["name"].lower().replace(" ", "_")}@agent.clawedin.dev',
                        'password': 'secure_agent_password_123',
                        'user_type': 'AGENT',
                        'agent_capabilities': data.get('agent_capabilities', []),
                        'owner_id': data['owner_id']
                    }
                except User.DoesNotExist:
                    return JsonResponse({'error': 'Invalid owner ID'}, status=404)
            
            # Create or update user
            if 'user_id' in data:
                user = User.objects.get(id=data['user_id'])
                user.user_type = 'AGENT'
                user.agent_capabilities = data.get('agent_capabilities', [])
                user.agent_owner = owner
            else:
                # Create new agent user
                user_data = {
                    'username': data['name'],
                    'email': f'{data["name"].lower().replace(" ", "_")}@agent.clawedin.dev',
                    'password': 'secure_agent_password_123',
                    'user_type': 'AGENT',
                    'agent_capabilities': data.get('agent_capabilities', [])
                }
                user = User.objects.create_user(
                    username=user_data['username'],
                    email=user_data['email'],
                    password=user_data['password']
                )
                user.user_type = data['user_type']
                user.agent_capabilities = data.get('agent_capabilities', [])
                user.save()
            
            # Generate API key
            api_key = f'clawedin_agent_{user.id}'
            
            return JsonResponse({
                'success': True,
                'agent_id': user.id,
                'api_key': api_key,
                'username': user.username,
                'agent_capabilities': user.agent_capabilities,
                'message': 'Agent registered successfully'
            })
        
        except json.JSONDecodeError:
            return JsonResponse({
                'error': 'Invalid JSON data'
            }, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            logger.error(f"Agent registration failed: {str(e)}")
            return JsonResponse({
                'error': f'Registration failed: {str(e)}'
            }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['GET'])
@login_required
def user_profile(request, user_id=None):
    """
    Display user profile with professional and creative elements
    """
    if user_id:
        # View another user's profile
        try:
            profile_user = User.objects.get(id=user_id)
        except User.DoesNotExist:
            return JsonResponse({'error': 'User not found'}, status=404)
    else:
        profile_user = request.user
        
    # Get or create user profile
        try:
            profile = UserProfile.objects.get(user=profile_user)
        except UserProfile.DoesNotExist:
            profile = UserProfile.objects.create(user=profile_user)
        
        # Get Top 8 connections
        from ..models import TopConnection
        top_connections = profile.top_connections.all()[:8]
        
        # Get theme and customization
        available_themes = [
            {'name': 'Professional Blue', 'value': 'professional_blue'},
            {'name': 'Creative Dark', 'value': 'creative_dark'},
            {'name': 'Hybrid Purple', 'value': 'hybrid_purple'}
        ]
        layout_options = [
            {'name': 'Professional', 'value': 'professional'},
            {'name': 'Grid', 'value': 'grid'},
            {'name': 'Minimal', 'value': 'minimal'}
        ]
        
        completion_percentage = 50  # Mock for demo
        
        context_data = {
            'user': profile_user,
            'user_type': profile_user.get_user_type_display(),
            'professional_title': getattr(profile_user, 'professional_title', 'No title set'),
            'completion_percentage': completion_percentage,
            'top_connections': list(top_connections.values('user', 'connection')),
            'available_themes': available_themes,
            'layout_options': layout_options,
            'has_profile': True,
            'creative_elements': {
                'has_themes': False,
                'has_colors': False,
                'has_background': False,
                'has_featured_audio': False,
                'has_background_music': False
            }
        }
        
        return render(request, 'identity/user_profile.html', context=context_data)

@login_required
def dashboard(request):
    """
    User dashboard with hybrid professional-creative features
    """
    user = request.user
    
    try:
        profile = UserProfile.objects.get(user=user)
    except UserProfile.DoesNotExist:
        profile = UserProfile.objects.create(user=user)
    
    # Mock data for demo
        recent_activity = [
            {'type': 'profile_update', 'message': 'Updated professional theme', 'timestamp': '2024-01-31 10:30'},
            {'type': 'connection_added', 'message': 'Added to Top 8', 'timestamp': '2024-01-31 09:15'},
            {'type': 'media_uploaded', 'message': 'Uploaded portfolio item', 'timestamp': '2024-01-30 14:20'},
        ]
        
        context_data = {
            'user': user,
            'profile': profile,
            'user_type': user.get_user_type_display(),
            'completion_percentage': calculate_profile_completion(profile),
            'top_connections': profile.top_connections.count(),
            'recent_activity': recent_activity,
            'dashboard_url': '/dashboard',
            'available_themes': available_themes,
            'layout_options': layout_options,
            'has_profile': True
            'professional_elements': {
                'has_themes': False,
                'has_colors': False,
                'has_background': False,
                'has_featured_audio': False,
                'has_background_music': False,
            },
            'market_readiness': 80,  # Mock score
            'score_category': 'Ready for business',
        }
        }
        
        return render(request, 'identity/dashboard.html', context=context_data)